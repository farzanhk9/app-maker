import os, json, argparse, textwrap, re

MAIN_TEMPLATE = """// GENERATED BY app_maker.py
import 'package:flutter/material.dart';
import 'pages/generated_pages.dart';

void main() {
  runApp(const GeneratedApp());
}

class GeneratedApp extends StatelessWidget {
  const GeneratedApp({super.key});

  @override
  Widget build(BuildContext context) {
    final seed = _parseColor('{themeSeed}');
    return MaterialApp(
      title: '{appName}',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: seed),
        useMaterial3: true,
      ),
      home: const RootScaffold(),
    );
  }

  Color _parseColor(String hex) {
    final cleaned = hex.replaceAll('#', '');
    final value = int.parse('FF$cleaned', radix: 16);
    return Color(value);
  }
}
"""

ROOT_SCAFFOLD_TEMPLATE = """// GENERATED
import 'package:flutter/material.dart';
import 'generated_pages.dart';

class RootScaffold extends StatefulWidget {
  const RootScaffold({super.key});

  @override
  State<RootScaffold> createState() => _RootScaffoldState();
}

class _RootScaffoldState extends State<RootScaffold> {{
  int _index = 0;

  final _pages = <Widget>[
{page_constructors}
  ];

  final _titles = <String>[
{page_titles}
  ];

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(title: Text(_titles[_index])),
      body: _pages[_index],
      bottomNavigationBar: {bottom_nav},
      drawer: {drawer},
    );
  }}
}}
"""

BOTTOM_NAV_TEMPLATE = """NavigationBar(
  selectedIndex: _index,
  onDestinationSelected: (i) => setState(() => _index = i),
  destinations: const <NavigationDestination>[
{destinations}
  ],
)"""

DRAWER_TEMPLATE = """Drawer(
  child: SafeArea(
    child: ListView(
      children: <Widget>[
{drawer_items}
      ],
    ),
  ),
)"""

DRAWER_ITEM_TEMPLATE = """ListTile(
  leading: Icon({icon}),
  title: Text('{title}'),
  selected: _index == {i},
  onTap: () { Navigator.pop(context); setState(() => _index = {i}); },
),"""

DEST_TEMPLATE = "NavigationDestination(icon: Icon({icon}), label: '{label}'),"

GENERATED_PAGES_HEADER = """// GENERATED PAGES
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

{page_classes}
"""

PAGE_CLASS_TEMPLATE = """class {className} extends StatelessWidget {{
  const {className}({{super.key}});

  @override
  Widget build(BuildContext context) {{
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: <Widget>[
{widgets}
        ],
      ),
    );
  }}
}}
"""

W_TEXT = """Text(
  {text},
  style: {style},
),"""

W_BUTTON = """FilledButton(
  onPressed: () {{
    {onPressed}
  }},
  child: Text({label}),
),"""

W_IMAGE = """ClipRRect(
  borderRadius: BorderRadius.circular(12),
  child: Image.network(
    {url},
    height: 200,
    width: double.infinity,
    fit: BoxFit.cover,
    errorBuilder: (_, __, ___) => const SizedBox(
      height: 200,
      child: Center(child: Icon(Icons.image_not_supported)),
    ),
  ),
),"""

W_LIST = """Column(
  children: <Widget>[
{items}
  ],
),"""

W_LIST_ITEM = """Card(
  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
  child: ListTile(
    leading: {leading},
    title: Text({title}),
    subtitle: {subtitle},
    trailing: const Icon(Icons.chevron_right),
    onTap: () {{}},
  ),
),"""

W_FORM = """_GeneratedForm(
  fields: const <_FormFieldSpec>[
{fields}
  ],
  submitLabel: {submitLabel},
),"""

FORM_WIDGET = """class _GeneratedForm extends StatefulWidget {
  final List<_FormFieldSpec> fields;
  final String submitLabel;
  const _GeneratedForm({required this.fields, required this.submitLabel});

  @override
  State<_GeneratedForm> createState() => _GeneratedFormState();
}

class _GeneratedFormState extends State<_GeneratedForm> {
  final _formKey = GlobalKey<FormState>();
  final Map<String, dynamic> _values = {};

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 1,
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Form(
          key: _formKey,
          child: Column(
            children: [
              ...widget.fields.map((f) {
                return Padding(
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  child: TextFormField(
                    decoration: InputDecoration(
                      labelText: f.label,
                      border: const OutlineInputBorder(),
                    ),
                    maxLines: f.kind == 'multiline' ? 4 : 1,
                    keyboardType: f.kind == 'email'
                        ? TextInputType.emailAddress
                        : TextInputType.text,
                    validator: (v) {
                      if ((v ?? '').trim().isEmpty) return 'Required';
                      if (f.kind == 'email' && !(v!.contains('@'))) return 'Invalid email';
                      return null;
                    },
                    onSaved: (v) => _values[f.name] = v,
                  ),
                );
              }),
              const SizedBox(height: 12),
              FilledButton.icon(
                onPressed: () {
                  if (_formKey.currentState!.validate()) {
                    _formKey.currentState!.save();
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(content: Text('Submitted: ' + _values.toString())),
                    );
                  }
                },
                icon: const Icon(Icons.send),
                label: Text(widget.submitLabel),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _FormFieldSpec {
  final String name;
  final String label;
  final String kind; // text | email | multiline
  const _FormFieldSpec({required this.name, required this.label, required this.kind});
}
"""

FORM_FIELD_ITEM = "_FormFieldSpec(name: '{name}', label: '{label}', kind: '{kind}'),"

PUBSPEC = """name: {safeName}
description: Generated Flutter app
publish_to: "none"
version: 1.0.0+1

environment:
  sdk: ">=3.3.0 <4.0.0"

dependencies:
  flutter:
    sdk: flutter

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^4.0.0

flutter:
  uses-material-design: true
"""

ICON_MAP = {
    "home": "Icons.home_outlined",
    "store": "Icons.store_outlined",
    "phone": "Icons.phone_outlined",
    "list": "Icons.list_alt_outlined",
    "info": "Icons.info_outline",
    "person": "Icons.person_outline",
    "shopping": "Icons.shopping_bag_outlined",
    "settings": "Icons.settings_outlined"
}

def camel_case(s: str) -> str:
    s = re.sub(r'[^a-zA-Z0-9]+', ' ', s).strip()
    parts = s.split()
    return ''.join(w.capitalize() for w in parts) or 'Page'

def safe_name(name: str) -> str:
    s = re.sub(r'[^a-z0-9_]+', '_', name.lower()).strip('_')
    return s or 'generated_app'

def widget_from_spec(w, pages_ids):
    t = w.get("type")
    if t == "text":
        style = w.get("style", "body")
        style_expr = "Theme.of(context).textTheme.titleLarge" if style=="title" else "Theme.of(context).textTheme.bodyMedium"
        return W_TEXT.format(text=repr(w.get("value","")), style=style_expr)
    if t == "button":
        target = w.get("navigateTo")
        handler = f"Navigator.of(context).push(MaterialPageRoute(builder: (_)=> const {camel_case(target)}Page()));" if target in pages_ids else "ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('No navigation target')));"
        return W_BUTTON.format(onPressed=handler, label=repr(w.get("label","Button")))
    if t == "image":
        return W_IMAGE.format(url=repr(w.get("url","")))
    if t == "list":
        items_code = []
        for it in w.get("items", []):
            leading = f"ClipRRect(borderRadius: BorderRadius.circular(8), child: Image.network({repr(it.get('image',''))}, width: 56, height: 56, fit: BoxFit.cover, errorBuilder: (_, __, ___) => const ColoredBox(color: Color(0xFFEDE7F6), child: SizedBox(width:56,height:56, child: Icon(Icons.image_not_supported))),))" if it.get("image") else "const Icon(Icons.label_outline)"
            subtitle = f"Text({repr(it.get('subtitle',''))})" if it.get("subtitle") else "null"
            items_code.append(W_LIST_ITEM.format(leading=leading, title=repr(it.get('title','Item')), subtitle=subtitle))
        return W_LIST.format(items="\n".join(items_code))
    if t == "form":
        fields = w.get("fields", [])
        fields_code = "\n".join([FORM_FIELD_ITEM.format(name=f["name"], label=f["label"], kind=f.get("kind","text")) for f in fields])
        return W_FORM.format(fields=fields_code, submitLabel=repr(w.get("submitLabel","Submit")))
    return "// Unsupported widget"

def generate(spec, out_dir):
    os.makedirs(out_dir, exist_ok=True)
    # pubspec
    with open(os.path.join(out_dir, "pubspec.yaml"), "w", encoding="utf-8") as f:
        f.write(PUBSPEC.format(safeName=safe_name(spec.get("appName","GeneratedApp"))))

    lib_dir = os.path.join(out_dir, "lib")
    pages_dir = os.path.join(lib_dir, "pages")
    os.makedirs(pages_dir, exist_ok=True)

    # main.dart
    with open(os.path.join(lib_dir, "main.dart"), "w", encoding="utf-8") as f:
        f.write(MAIN_TEMPLATE.format(
            appName=spec.get("appName","Generated App"),
            themeSeed=spec.get("themeSeed","#6750A4")
        ))

    pages = spec.get("pages", [])
    page_ids = [p["id"] for p in pages]

    # build page classes
    page_classes_code = [FORM_WIDGET]
    titles = []
    constructors = []
    destinations = []
    drawer_items = []

    for i, p in enumerate(pages):
        class_name = camel_case(p["id"]) + "Page"
        titles.append(repr(p.get("title", p["id"])))
        constructors.append(f"const {class_name}(),")
        # widgets
        ws = []
        for w in p.get("widgets", []):
            ws.append(widget_from_spec(w, page_ids))
        page_classes_code.append(PAGE_CLASS_TEMPLATE.format(
            className=class_name,
            widgets="\n".join(ws) if ws else "const Text('Empty page'),"
        ))
        # icons
        icon = ICON_MAP.get(p.get("icon","info"), "Icons.info_outline")
        destinations.append(DEST_TEMPLATE.format(icon=icon, label=p.get("title", p["id"])))
        drawer_items.append(DRAWER_ITEM_TEMPLATE.format(icon=icon, title=p.get("title", p["id"]), i=i))

    with open(os.path.join(pages_dir, "generated_pages.dart"), "w", encoding="utf-8") as f:
        f.write(GENERATED_PAGES_HEADER.format(page_classes="\n\n".join(page_classes_code)))

    nav = spec.get("navigation","bottom")
    if nav not in ("bottom","drawer"): nav = "bottom"

    bottom_nav_code = BOTTOM_NAV_TEMPLATE.format(destinations="\n".join(destinations)) if nav=="bottom" else "null"
    drawer_code = DRAWER_TEMPLATE.format(drawer_items="\n".join(drawer_items)) if nav=="drawer" else "null"

    with open(os.path.join(pages_dir, "root_scaffold.dart"), "w", encoding="utf-8") as f:
        f.write(ROOT_SCAFFOLD_TEMPLATE.format(
            page_constructors="\n".join(constructors),
            page_titles="\n".join(titles),
            bottom_nav=bottom_nav_code,
            drawer=drawer_code
        ))

    # also export barrel file that imports root scaffold (for main.dart)
    # (already imported generated_pages.dart in root)
    # Done
    print(f"✅ Flutter app generated in: {out_dir}")

def main():
    ap = argparse.ArgumentParser(description="Generate a Flutter app from a JSON spec.")
    ap.add_argument("--spec", required=True, help="Path to spec.json")
    ap.add_argument("--out", required=True, help="Output directory (new Flutter app folder)")
    args = ap.parse_args()

    with open(args.spec, "r", encoding="utf-8") as f:
        spec = json.load(f)

    # Create minimal flutter project structure
    os.makedirs(args.out, exist_ok=True)
    os.makedirs(os.path.join(args.out, "lib", "pages"), exist_ok=True)

    generate(spec, args.out)

if __name__ == "__main__":
    main()

